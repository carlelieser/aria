name: Release

on:
    push:
        tags:
            - 'v*'
    workflow_dispatch:
        inputs:
            version:
                description: 'Version to release (e.g., 1.0.0)'
                required: true
                type: string

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: false

env:
    VERSION: ${{ github.event.inputs.version || github.ref_name }}

jobs:
    validate:
        name: Validate Release
        runs-on: self-hosted
        outputs:
            version: ${{ steps.version.outputs.version }}
        steps:
            - name: Checkout repository
              uses: actions/checkout@v6
              with:
                  fetch-depth: 0

            - name: Extract version
              id: version
              run: |
                  VERSION="${{ env.VERSION }}"
                  VERSION="${VERSION#v}"
                  echo "version=$VERSION" >> $GITHUB_OUTPUT
                  echo "Releasing version: $VERSION"

            - name: Setup Node.js
              uses: actions/setup-node@v6
              with:
                  node-version: 20
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Run quality checks
              run: |
                  npm run lint
                  npm run format:check
                  npx tsc --noEmit
                  npm run test:run

            - name: Run Expo checks
              run: |
                  npx expo-doctor
                  npx expo install --check

    build-android:
        name: Build Android
        runs-on: self-hosted
        needs: validate
        steps:
            - name: Checkout repository
              uses: actions/checkout@v6

            - name: Setup Node.js
              uses: actions/setup-node@v6
              with:
                  node-version: 20
                  cache: 'npm'

            - name: Setup Java
              uses: actions/setup-java@v4
              with:
                  distribution: 'temurin'
                  java-version: '17'

            - name: Setup Android SDK
              uses: android-actions/setup-android@v3

            - name: Install Ninja
              run: |
                  if command -v apt-get &> /dev/null; then
                    sudo apt-get update && sudo apt-get install -y ninja-build
                  elif command -v brew &> /dev/null; then
                    brew install ninja
                  fi

            - name: Install dependencies
              run: npm ci

            - name: Generate native project
              run: npx expo prebuild --platform android --clean

            - name: Build Debug APK
              working-directory: android
              run: ./gradlew assembleDebug

            - name: Build Release APK
              working-directory: android
              run: ./gradlew assembleRelease

            - name: Upload Debug APK
              uses: actions/upload-artifact@v4
              with:
                  name: aria-${{ needs.validate.outputs.version }}-debug
                  path: android/app/build/outputs/apk/debug/app-debug.apk
                  retention-days: 90

            - name: Upload Release APK
              uses: actions/upload-artifact@v4
              with:
                  name: aria-${{ needs.validate.outputs.version }}-release
                  path: android/app/build/outputs/apk/release/app-release.apk
                  retention-days: 90

    create-release:
        name: Create GitHub Release
        runs-on: self-hosted
        needs: [validate, build-android]
        permissions:
            contents: write
        steps:
            - name: Checkout repository
              uses: actions/checkout@v6
              with:
                  fetch-depth: 0

            - name: Download Debug APK
              uses: actions/download-artifact@v4
              with:
                  name: aria-${{ needs.validate.outputs.version }}-debug
                  path: artifacts/debug

            - name: Download Release APK
              uses: actions/download-artifact@v4
              with:
                  name: aria-${{ needs.validate.outputs.version }}-release
                  path: artifacts/release

            - name: Rename APKs
              run: |
                  mv artifacts/debug/app-debug.apk artifacts/aria-${{ needs.validate.outputs.version }}-debug.apk
                  mv artifacts/release/app-release.apk artifacts/aria-${{ needs.validate.outputs.version }}-release.apk

            - name: Generate changelog
              id: changelog
              run: |
                  PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
                  if [ -n "$PREVIOUS_TAG" ]; then
                    echo "Generating changelog from $PREVIOUS_TAG to HEAD"
                    CHANGELOG=$(git log $PREVIOUS_TAG..HEAD --pretty=format:"- %s (%h)" --no-merges)
                  else
                    echo "No previous tag found, generating full changelog"
                    CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges -20)
                  fi
                  echo "changelog<<EOF" >> $GITHUB_OUTPUT
                  echo "$CHANGELOG" >> $GITHUB_OUTPUT
                  echo "EOF" >> $GITHUB_OUTPUT

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: v${{ needs.validate.outputs.version }}
                  name: Release v${{ needs.validate.outputs.version }}
                  body: |
                      ## What's Changed

                      ${{ steps.changelog.outputs.changelog }}

                      ## Downloads

                      | Variant | Description |
                      |---------|-------------|
                      | `aria-${{ needs.validate.outputs.version }}-debug.apk` | Debug build for testing |
                      | `aria-${{ needs.validate.outputs.version }}-release.apk` | Release build for distribution |
                  files: |
                      artifacts/aria-${{ needs.validate.outputs.version }}-debug.apk
                      artifacts/aria-${{ needs.validate.outputs.version }}-release.apk
                  draft: false
                  prerelease: ${{ contains(needs.validate.outputs.version, 'alpha') || contains(needs.validate.outputs.version, 'beta') }}
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
