name: Build

on:
    workflow_dispatch:
        inputs:
            platform:
                description: 'Platform to build'
                required: true
                default: 'all'
                type: choice
                options:
                    - all
                    - android
                    - ios
            profile:
                description: 'Build profile'
                required: true
                default: 'preview'
                type: choice
                options:
                    - development
                    - preview
                    - production

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}-${{ inputs.platform }}-${{ inputs.profile }}
    cancel-in-progress: true

jobs:
    validate:
        name: Validate Expo Project
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v6

            - name: Setup Node.js
              uses: actions/setup-node@v6
              with:
                  node-version: 20
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Run Expo Doctor
              run: npx expo-doctor

            - name: Check Expo dependency compatibility
              run: npx expo install --check

    build-android:
        name: Build Android
        if: ${{ inputs.platform == 'all' || inputs.platform == 'android' }}
        runs-on: ubuntu-latest
        needs: validate
        steps:
            - name: Checkout repository
              uses: actions/checkout@v6

            - name: Setup Node.js
              uses: actions/setup-node@v6
              with:
                  node-version: 20
                  cache: 'npm'

            - name: Setup EAS
              uses: expo/expo-github-action@v8
              with:
                  eas-version: latest
                  token: ${{ secrets.EXPO_TOKEN }}

            - name: Install dependencies
              run: npm ci

            - name: Build Android
              run: eas build --platform android --profile ${{ inputs.profile }} --non-interactive

    build-ios:
        name: Build iOS
        if: ${{ inputs.platform == 'all' || inputs.platform == 'ios' }}
        runs-on: ubuntu-latest
        needs: validate
        steps:
            - name: Checkout repository
              uses: actions/checkout@v6

            - name: Setup Node.js
              uses: actions/setup-node@v6
              with:
                  node-version: 20
                  cache: 'npm'

            - name: Setup EAS
              uses: expo/expo-github-action@v8
              with:
                  eas-version: latest
                  token: ${{ secrets.EXPO_TOKEN }}

            - name: Install dependencies
              run: npm ci

            - name: Build iOS
              run: eas build --platform ios --profile ${{ inputs.profile }} --non-interactive

    build-summary:
        name: Build Summary
        runs-on: ubuntu-latest
        needs: [build-android, build-ios]
        if: always()
        steps:
            - name: Check build results
              run: |
                  echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
                  echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
                  echo "| Android | ${{ needs.build-android.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| iOS | ${{ needs.build-ios.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY

                  if [[ "${{ needs.build-android.result }}" == "failure" ]] || [[ "${{ needs.build-ios.result }}" == "failure" ]]; then
                    echo "One or more builds failed"
                    exit 1
                  fi
                  echo "All requested builds completed successfully!"
